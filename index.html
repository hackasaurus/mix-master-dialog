<!DOCTYPE html>
<meta charset="utf-8">
<title>DOM Tutorial</title>
<link rel="stylesheet" href="webxray/static-files/webxray.css">
<script src="jquery.min.js"></script>
<script src="protovis-r3.2.js"></script>
<script src="ace/ace.js"></script>
<script src="ace/mode-html.js"></script>
<script src="ace/theme-eclipse.js"></script>
<script src="webxray/src/utils.js"></script>
<script src="webxray/src/tag-colors.js"></script>
<script src="webxray/src/hud-overlay.js"></script>
<style>
body {
  font-family: Baskerville;
}

h2 {
  font-weight: normal;
  margin-top: 0.5em;
  margin-bottom: 0.1em;
}

div.column {
  width: 300px;
  float: left;
  margin-left: 1em;
}

div.desc {
  font-size: 9pt;
  color: gray;
  height: 6em;
}

#editor-container {
  position: relative;
  width: 280px;
  height: 280px;
  border: 1px dotted gray;
}

#editor { 
  position: absolute;
  top: 3px;
  left: 3px;
  width: 280px;
  height: 280px;
  margin: 0;
}

/* Hide the horizontal scrollbar of the editor. */
.ace_scroller {
  overflow: hidden;
}

/* Hide the vertical scrollbar of the editor. */
.ace_sb {
  display: none;
}

.highlight {
  background-color: yellow;
}

pre {
  font-family: Monaco, monospace;
  font-size: 9pt;
}

pre span.tag {
  color: purple;
}

svg {
  padding-top: 1em;
}
</style>
<script>
var START_HTML = 
  "<p>I had <em>nothing</em> to do with it.</p>\n\n" +
  "<p>And you are a goose.</p>";

START_HUD_HTML =
  "<span>Play around with the HTML code and move your mouse " +
  "over the DOM diagram to learn how Web pages work.</span>";

function makeProtovisDOMfromDOM(dom, name) {
  var pvNode = new pv.Dom.Node();
  pvNode.nodeName = name;
  var childNode;

  dom = $(dom).get(0);
  pvNode.realDOMNode = dom;
  for (var i = 0; i < dom.childNodes.length; i++) {
    var node = dom.childNodes[i];
    switch (node.nodeType) {
      case node.ELEMENT_NODE:
      var name = node.nodeName.toLowerCase();
      childNode = makeProtovisDOMfromDOM($(node), name);
      childNode.realDOMNode = node;
      pvNode.appendChild(childNode);
      break;
    }
  }
  return pvNode;
}

function createHighlighter(hud) {
  var overlay = null;
  
  function clearOverlay() {
    if (overlay) {
      overlay.remove();
      overlay = null;
    }
    hud.onFocusChange({element: null, ancestor: null});
  }

  return {
    over: function(d) {
      clearOverlay();
      if (d.realDOMNode) {
        var node = d.realDOMNode;
        overlay = $(node).overlayWithTagColor();
        overlay.addClass("webxray-overlay-visible");

        var parent = node.parentNode;

        // TODO: This is a dumb hack to make the root node seem as
        // simple as we tell the user it is. But we should actually just
        // structure the DOM simply instead of intervening here.
        if ($(node).is("div.content"))
          node = document.createElement("div");
        if ($(parent).is("div.content"))
          parent = document.createElement("div");
        if ($(parent).is("div.column"))
          parent = null;

        hud.onFocusChange({element: node, ancestor: parent});
      }
    },

    out: function(d) {
      clearOverlay();
    }
  };
}

function makeSunburst(div, dom, hud) {
  var vis = new pv.Panel()
                  .width(div.width())
                  .height(div.width())
                  .canvas(div.get(0));
  
  var spacing = 8;
  
  var tree = vis.add(pv.Layout.Indent)
      .nodes(dom.nodes())
      .depth(spacing * 2)
      .breadth(spacing * 2);

  tree.link.add(pv.Line);
  
  var node = tree.node.add(pv.Panel)
      .top(function (n) { return n.y - spacing; })
      .height(spacing * 2)
      .right(spacing)
      .strokeStyle(null);

  var highlighter = createHighlighter(hud);

  node.anchor("left").add(pv.Dot)
      .strokeStyle(function(d) {
        return $.colorForTag(d.nodeName);
      })
      .fillStyle(function(d) {
        return $.makeRGBA($.colorForTag(d.nodeName), 0.5);
      })
      .event("mouseover", highlighter.over)
      .event("mouseout", highlighter.out)
      .anchor("right").add(pv.Label)
      .font("9pt Monaco, monospace")
      .text(function(d) { return d.nodeName; });

  vis.render();
}

function setupEditor(onChange) {
  function onChangeWrapper() {
    var text = session.getDocument().getValue();
    onChange(text);
  }

  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/eclipse");
  var HTMLMode = require("ace/mode/html").Mode;
  var session = editor.getSession();
  session.setMode(new HTMLMode());
  editor.renderer.setShowGutter(false);
  editor.setHighlightActiveLine(false);
  session.setUseWrapMode(true);
  session.setWrapLimitRange(36, 36);
  session.getDocument().on("change", onChangeWrapper);
  onChangeWrapper();
}

$(window).ready(function() {
  var rendering = $("#rendering div.content");
  var sunburst = $("#sunburst div.content");

  var hud = jQuery.hudOverlay({defaultContent: START_HUD_HTML});
  $(document.body).append(hud.overlay);

  $("pre#editor").text(START_HTML);

  setupEditor(function onChange(text) {
    rendering.html(text);
    makeSunburst(sunburst, makeProtovisDOMfromDOM(rendering, 'div'), hud);
  });
});
</script>
<div id="html" class="column">
  <h2>HTML</h2>
  <div class="desc">This is what every page on the Web comes from: plain-text source code that anyone can read.</div>
  <pre>&lt;<span class="tag">div</span>&gt;</pre>
  <div id="editor-container"><pre id="editor"></pre></div>
  <pre>&lt;/<span class="tag">div</span>&gt;</pre>
</div>
<div id="sunburst" class="column">
  <h2>Document Object Model</h2>
  <div class="desc">A Web browser reads the HTML and generates a tree-like structure that represents the content of the document, how it's styled, and how it behaves.<br><br>Understand the DOM and you master the Web.</div>
  <div class="content"></div>
</div>
<div id="rendering" class="column">
  <h2>The Final Product</h2>
  <div class="desc">All the parts of a Web browser work together to create a page that can be seen, heard, and even interacted with.<br><br>It's like magic ink.</div>
  <div class="content"></div>
</div>
