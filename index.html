<!DOCTYPE html>
<meta charset="utf-8">
<title>DOM Tutorial</title>
<script src="jquery.min.js"></script>
<script src="protovis-r3.2.js"></script>
<script src="ace/ace.js"></script>
<script src="ace/mode-html.js"></script>
<script src="ace/theme-eclipse.js"></script>
<style>
body {
  font-family: Baskerville;
}

h2 {
  font-weight: normal;
}

div.column {
  width: 300px;
  float: left;
}

#editor-container {
  position: relative;
  width: 280px;
  height: 280px;
  border: 1px dotted gray;
}

#editor { 
  position: absolute;
  top: 3px;
  left: 3px;
  width: 280px;
  height: 280px;
  margin: 0;
}

/* Hide the horizontal scrollbar of the editor. */
.ace_scroller {
  overflow: hidden;
}

/* Hide the vertical scrollbar of the editor. */
.ace_sb {
  display: none;
}
</style>
<script>
var START_HTML = "<p>I had <em>nothing</em> to do with it.</p>";

function makeProtovisDOMfromDOM(dom, name) {
  var pvNode = new pv.Dom.Node();
  pvNode.nodeName = name;
  var childNode;

  dom = $(dom).get(0);
  for (var i = 0; i < dom.childNodes.length; i++) {
    var node = dom.childNodes[i];
    switch (node.nodeType) {
      case node.ELEMENT_NODE:
      var name = '<' + node.nodeName.toLowerCase() + '>';
      childNode = makeProtovisDOMfromDOM($(node), name);
      pvNode.appendChild(childNode);
      break;

      case node.TEXT_NODE:
      childNode = new pv.Dom.Node(node.nodeValue.length);
      childNode.nodeName = node.nodeValue;
      pvNode.appendChild(childNode);
      break;
    }
  }
  return pvNode;
}

function makeSunburst(div, dom) {
  var vis = new pv.Panel()
                  .width(div.width())
                  .height(div.width())
                  .canvas(div.get(0));
  
  var partition = vis.add(pv.Layout.Partition.Fill)
      .nodes(dom.nodes())
      .size(function(d) { return d.nodeValue})
      .order("descending")
      .orient("radial");
      
  partition.node.add(pv.Wedge)
      .fillStyle(pv.Colors.category19().by(function(d) {
        return d.parentNode && d.parentNode.nodeName;
      }))
      .strokeStyle("#fff")
      .lineWidth(.5);

  partition.label.add(pv.Label)
           .visible(function(d) {
             return d.angle * d.outerRadius >= 6;
           });

  vis.render();
}

function setupEditor(onChange) {
  function onChangeWrapper() {
    var text = session.getDocument().getValue();
    onChange(text);
  }

  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/eclipse");
  var HTMLMode = require("ace/mode/html").Mode;
  var session = editor.getSession();
  session.setMode(new HTMLMode());
  editor.renderer.setShowGutter(false);
  editor.setHighlightActiveLine(false);
  session.setUseWrapMode(true);
  session.setWrapLimitRange(36, 36);
  session.getDocument().on("change", onChangeWrapper);
  onChangeWrapper();
}

$(window).ready(function() {
  var rendering = $("#rendering div.content");
  var sunburst = $("#sunburst div.content");

  $("pre").text(START_HTML);

  setupEditor(function onChange(text) {
    rendering.html(text);
    makeSunburst(sunburst, makeProtovisDOMfromDOM(rendering, '<body>'));
    // I have no idea how to do this kind of thing
    // through Protovis, so I'll just do it with the SVG
    // output.
    sunburst.find("text").each(function() {
      var text = $(this).text();
      text = $.trim(text);
      if (text[0] == '<') {
        // I wish we could just use CSS classes here, but
        // addClass() doesn't seem to do anything. Silly
        // SVG and its strange world.
        $(this).attr("font-family", "Monaco, monospace");
        $(this).attr("font-size", "10pt");
        $(this).text(text.substring(1, text.length-1));
      } else {
        $(this).attr("font-family", "Baskerville, serif");
        $(this).attr("font-size", "10pt");
        // Let's remove the whitespace around it.
        $(this).text(text);
      }
    });
  });
});
</script>
<div id="html" class="column">
  <h2>The HTML</h2>
  <div id="editor-container"><pre id="editor"></pre></div>
</div>
<div id="rendering" class="column">
  <h2>How You See It</h2>
  <div class="content"></div>
</div>
<div id="sunburst" class="column">
  <h2>How Your Computer Sees It</h2>
  <div class="content"></div>
</div>
